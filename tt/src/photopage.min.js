window.processComments={initialise:function(o,t,n,e){var i=this;i.comPage=0,i.comParentBlock=$("#photoModalWrap").find(o),i.comShowBtn=$(t),i.comAddBtn=$(n),i.comAddFrm=$(e),i.loadCmtsFlag=!0,i.comLoading=$("#modalCmtsLoading"),$(i.comAddBtn).click(function(o){o.preventDefault(),$(this).parent().addClass("comAddOpened"),window.processComments.posAddComBtn("position")}),$("<a/>",{id:"hideComFrm",text:window.ulb.closeBtn,style:"margin-left: 5px"}).addClass("button").insertAfter("#addcBut").click(function(){$("#mphoto-addcmt").removeClass("comAddOpened"),window.processComments.posAddComBtn("position")}),i.commentsBuffer=null,i.commentsUrl=i.getCommentsUrl(window.photo.currentUrl),i.loadComments(i.commentsUrl.url,i.commentsUrl.entryId),$("#photoModalWrap").scroll(function(o){i.loadCmtsFlag&&$(window).height()+$("#photoModalWrap").scrollTop()+window.processComments.paddingBoottom>=$("#photoModalWrap")[0].scrollHeight&&(window.processComments.comLoading.show(),i.loadComments(window.processComments.commentsUrl.url,window.processComments.commentsUrl.entryId)),window.processComments.posAddComBtn("reposition")}),window.processComments.posAddComBtn("position"),$(window).resize(function(){$("#photoModalWrap").length&&window.processComments.posAddComBtn("position")}),i.paddingBoottom=parseInt($(".fancybox-outer").css("padding-bottom"),10)+parseInt($(".fancybox-wrap").css("padding-bottom"),10),i.paddingTop=parseInt($(".fancybox-outer").css("padding-top"),10)+parseInt($(".fancybox-wrap").css("padding-top"),10),window.processComments.posAddComBtn("position")},posAddComBtn:function(o){var t=$("#mphoto-addcmt"),n=$("#photoModalWrap").find("#u-photo").outerHeight(),e=t.outerHeight(),i=$("#photoModalWrap").find("#u-photo").width();"position"===o&&t.width(i),$(window).height()+$("#photoModalWrap").scrollTop()+this.paddingBoottom<$("#photoModalWrap")[0].scrollHeight?($("#dynPhoto").css("padding-bottom",e+"px"),t.addClass("fixedAddComBtn"),t.css("margin-left",-i/2),0<=(o=$(window).height()+$("#photoModalWrap").scrollTop()-n-this.paddingTop-e)?t.css("bottom","0px"):t.css("bottom",o+"px")):(t.removeClass("fixedAddComBtn"),t.css("margin-left",0),$("#dynPhoto").css("padding-bottom","0px"))},getCommentsUrl:function(o){var t=(o=window.photo.getLastDigitFromUrl(o)).digit;return{url:window.photo.getLastDigitFromUrl(o.substrUrl).substrUrl,entryId:t}},loadComments:function(o,t){var e=this;e.comPage+=1,$.ajax({url:o+"-"+e.comPage+"-"+t+"-24",data:"json",error:function(o,t,n){console.log(t+", "+n),e.comments=null,window.processComments.comLoading.hide()},success:function(o,t){if(window.processComments.comLoading.hide(),null===o.comments||""===o.comments)console.log("no comments"),null!==e.commentsBuffer&&e.insertComments(e.commentsBuffer),e.comShowBtn.hide(),e.commentsBuffer=null,e.loadCmtsFlag=!1;else{var n=$("<div/>",{style:"display: none;",html:o.comments});console.log("got comments"),null===e.commentsBuffer?(e.insertComments(n),1!==e.comPage&&(e.commentsBuffer=n),e.loadComments(e.commentsUrl.url,e.commentsUrl.entryId)):(2!==e.comPage&&e.insertComments(e.commentsBuffer),e.commentsBuffer=n)}}})},insertComments:function(o){this.commentsBuffer=o,this.comParentBlock.append(o),o.fadeIn(200),window.processComments.posAddComBtn("reposition")}};var badBrowser=!(window.photo={init:function(){if($("#u-photos").length?window.photo.root=$("#u-photos"):window.photo.root=$("#uEntriesList"),window.photo.details=window.photo.root.find(".ph-js-details"),window.photo.modalDetails=$("#photoModalWrap").find(".ph-js-details"),window.photo.root.find(".ph-author").click(function(o){o.stopPropagation(),o.preventDefault()}),window.photo.detailsInit(window.photo.details,"window.photo.details"),$("body").click(function(){window.photo.details.removeClass("phr-opened"),window.photo.modalDetails.removeClass("phr-opened")}),badBrowser&&($(".photo-expand").hover(function(){$(this).addClass("hovered")},function(){$(this).removeClass("hovered")}),$("#oldPhotos").delegate("a","click",function(o){window.location.href=$(this).attr("href")})),"undefined"!=typeof uShowLightboxPage&&uShowLightboxPage){Object.size=function(o){var t,n=0;for(t in o)o.hasOwnProperty(t)&&n++;return n},window.photo.currentShownPage=window.photo.photoVars.currentPage,window.photo.pageUrlMask=window.photo.photoVars.pageUrlMask.replace("%a","2"),window.photo.photoVars.photoIds.length=Object.size(window.photo.photoVars.photoIds);var t=function(o,t){o.preventDefault(),window.photo.popupEvent=!1;var n=t.attr("href");window.photo.getRealUrl(n,function(o){for(var t=o.split("#")[0].split("/");"photo"!==t[t.length-2];)t.splice(t.length-2,1),t.join("/");t=t.join("/"),window.photo.modalId=window.photo.getLastDigitFromUrl(t).digit,(t=t.split("/")).splice(-1,1,"0-0-"+window.photo.modalId),t=t.join("/"),window.photo.fakeLoad(t,window.photo.loadModal)})};window.photo.root.find(".photo-title a, .phd-comments").click(function(o){return window.photo.currentShownPage=window.photo.photoVars.currentPage,t(o,$(this)),!1}),$.isFunction($.fn.live)?$(".ulb-photopage-link").live("click",function(o){return t(o,$(this)),!1}):$(".ulb-photopage-link").on("click",function(o){return t(o,$(this)),!1}),window.photo.originalTitle=$("title").text(),window.photo.autoFancyClose=!1,window.photo.popupEvent=!1,window.history&&history.pushState&&!navigator.userAgent.match(/(iPad|iPhone|iPod)/g)&&(window.photo.historyModern=!0,window.history.replaceState({ucozPhoto:!0},null,window.location.href),window.onpopstate=function(o){o.state&&window.photo.processPopstate()}),window.photo.processPopstate(),$(window).keydown(function(o){window.photo.nextLink&&"text"!==o.target.type&&"textarea"!==o.target.type&&(39===o.keyCode?window.photo.nextLink.click():37===o.keyCode&&window.photo.prevLink.click())})}},processPopstate:function(){var t;window.photo.popupEvent=!0,window.photo.autoFancyClose=!1,$.each(location.search.substring(1).split("&"),function(o){t=t||this.split("photo=")[1]}),t?window.photo.fakeLoad("//"+location.hostname+"/photo/0-0-"+t,window.photo.loadModal):$.fancybox&&(window.photo.autoFancyClose=!1,$.fancybox.close())},fakeLoad:function(o,t){window.photo.historyModern?(window.photo.currentUrl=o,console.log("loading..."),$.fancybox.showLoading&&$.fancybox.showLoading(),window.photo.modalId=window.photo.getLastDigitFromUrl(o).digit,window.photo.popupEvent?window.photo.autoFancyClose=!1:(window.photo.autoFancyClose=!0,window.history.pushState({ucozPhoto:!0},null,window.location.pathname+"?photo="+window.photo.modalId)),t(o)):window.location.href=o},loadModal:function(o){var e=this;o+="-22";var i="photo-"+window.photo.modalId;console.log("ID: "+i);var d=$("<div/>",{id:i,style:"display: none"}).appendTo("body");$.ajax({url:o,error:function(o,t,n){console.log(t+", "+n),e.comments=null},success:function(o,t){if(window.uCoz&&window.uCoz.uwbb&&!window.photo.popupEvent){var n=window.uCoz.uwbb.instances.pop();if(!n)return;var e=n.$txtArea;n.destroy(),e.remove(),$("textarea.commFl").wysibb()}d.html(o.currentPhoto).find("#acform").hide(),$.fancybox({fitToView:!1,autoHeight:!0,scrolling:"no",minWidth:parseInt(window.photo.pagePhotoWidth,10)+40,maxWidth:parseInt(window.photo.pagePhotoWidth,10)+240,href:"#"+i,padding:10,preload:5,openEffect:"fade",closeEffect:"fade",nextEffect:"fade",prevEffect:"fade",openEasing:"linear",nextEasing:"linear",prevEasing:"linear",fixed:fixedFlag,beforeShow:function(){$(".fancybox-wrap").wrap('<div id="photoModalWrap"></div>').wrap('<div id="fakeArrowsBlock"></div>'),window.photo.addNavArrows(window.photo.currentUrl),$("body").css({overflow:"hidden"}),document.title=$("#dynPhoto").find(".photo-etitle").text()+" - "+window.photo.originalTitle,window.photo.autoFancyClose=!1,window.photo.popupEvent=!1},afterShow:function(){if($("#fancybox-overlay").css("z-index",10005),window.processComments.initialise("#allEntries","#mphoto-showcmt","#mphoto-addcmt-btn","#acform"),window.photo.modalDetails=$("#photoModalWrap").find(".ph-js-details"),window.photo.detailsInit(window.photo.modalDetails,"window.photo.modalDetails"),window.addcom&&window.uCoz&&window.uCoz.uwbb){var o=window.addcom;window.addcom=function(){window.uCoz.uwbb.syncAll(),o()}}},beforeClose:function(){window.photo.autoFancyClose||window.photo.popupEvent||window.photo.historyModern&&window.history.pushState({ucozPhoto:!0},null,window.location.href.replace(window.location.search,"")),document.title=window.photo.originalTitle,window.photo.popupEvent=!1,window.photo.autoFancyClose=!1},afterClose:function(){$("body").css({overflow:"auto"}),$("#photoModalWrap").remove(),$("#"+i).remove()},helpers:{title:null,overlay:{opacity:.6,speedIn:0,speedOut:0}},keys:{next:{},prev:{}}})}})},getNextPrevIds:function(o){function t(o,n){return i="next"===n?a+1:a-1,void 0===(e=window.photo.photoVars.photoIds[window.photo.currentShownPage][i])&&("next"===n?(d=void 0!==window.photo.photoVars.photoIds[window.photo.currentShownPage+1]?window.photo.currentShownPage+1:1,window.photo.nextBtnPage=d):(d=void 0!==window.photo.photoVars.photoIds[window.photo.currentShownPage-1]?window.photo.currentShownPage-1:window.photo.photoVars.photoIds.length,window.photo.prevBtnPage=d),window.photo.photoVars.photoIds[d]?e="next"===n?window.photo.photoVars.photoIds[d][0]:window.photo.photoVars.photoIds[d][window.photo.photoVars.photoIds[d].length-1]:$.ajax({url:window.photo.pageUrlMask.replace("%p",d||2).replace(/\d$/,1),async:!1,error:function(o,t,n){console.log(t+", "+n)},success:function(o,t){o=o.map(function(o){return o[0]}),e="next"===n?o[0]:o[o.length-1],window.photo.photoVars.photoIds[d]=o}})),e}var e,i,d;o=parseInt(o,10),window.photo.currentId=o;var a=window.photo.photoVars.photoIds[window.photo.currentShownPage].indexOf(o);return window.photo.nextBtnPage=window.photo.currentShownPage,window.photo.prevBtnPage=window.photo.currentShownPage,{next:t(0,"next"),prev:t(0,"prev")}},addNavArrows:function(o){var n=this;o=(t=window.photo.getLastDigitFromUrl(o)).substrUrl;var t=(e=window.photo.getNextPrevIds(t.digit)).next,e=e.prev,i=$("#photoModalWrap");n.prevLink=$("<a/>",{href:o+"-"+e,html:"<span></span>",style:"display: none;"}).addClass("fancybox-nav modalArrow fancybox-prev").attr("data-changepage",window.photo.prevBtnPage),n.nextLink=n.prevLink.clone().attr("href",o+"-"+t).attr("data-changepage",window.photo.nextBtnPage).removeClass("fancybox-prev").addClass("fancybox-next"),$.each([n.prevLink,n.nextLink],function(){var t=this;t.insertBefore(i).fadeIn(),t.click(function(o){return o.preventDefault(),window.photo.autoFancyClose=!0,n.getRealUrl($(t).attr("href"),function(o){o&&(n.fakeLoad(o,n.loadModal),window.photo.currentShownPage=parseInt($(t).data("changepage"),10))}),!1})}),t=(o=$("<a/>").addClass("fakeArrow").attr("data-target",".fancybox-prev")).clone().attr("data-target",".fancybox-next").addClass("fakeArrowNext"),$.each([o,t],function(){i.find("#fakeArrowsBlock").append(this),this.hover(function(){$($(this).data("target")).addClass("hovered")},function(){$($(this).data("target")).removeClass("hovered")}),this.click(function(){$($(this).data("target")).trigger("click")})})},getLastDigitFromUrl:function(o){for(var t,n=-1;"-"!=t&&"/"!=t;)n-=1,t=o.slice(n,n+1);return t=o.slice(n+1),{substrUrl:o=o.slice(0,n),digit:t}},detailsInit:function(t,o){t.find(".phd-rating").click(function(o){return(o=$(this).parent()).hasClass("phr-opened")||(t.removeClass("phr-opened"),o.addClass("phr-opened")),!1}),t.find(".phd-dorating").each(function(){$(this).find("a").length||$(this).find(".u-current-rating").css("visibility","visible"),$(this).click(function(){return $(this).find(".u-current-rating").css("visibility","visible"),setTimeout(o+".removeClass('phr-opened')",900),!1})})},getRealUrl:function(o,t){$.ajax({headers:{getlink:1},url:o,dataType:"json",success:function(o){o.photo_id&&o.album_id&&(href="/photo/"+o.album_id+"-0-"+o.photo_id,t&&t(href))}})}});$(document).ready(function(){$.browser?$.browser.msie&&$.browser.version<10&&"BackCompat"==document.compatMode&&(badBrowser=!0):document.documentMode&&document.documentMode<10&&(badBrowser=!0),window.photo.init()});